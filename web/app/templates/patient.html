<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Page</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
    <script src="https://d3js.org/d3.v7.min.js" integrity="sha384-CjloA8y00+1SDAUkjs099PVfnY2KmDC2BZnws9kh8D/lX1s46w6EPhpXdqMfjK6i" crossorigin="anonymous"></script>
    {{ font_awesome.load_js() }}
    <style>
      body {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      }
      .login {
        color: #fff;
        background-color: #667eea;
        transition: 0.5s ease-in-out;
      }
      .login:hover {
        transform: scale(1.2);
        transition: 0.5s ease-in-out;
        background-color: #764ba2;
      }
      .main {
        display: grid;
        width: 100%;
        height: 100%;
        grid-template-columns: auto auto;
        grid-template-rows: 30% 65%;
      }
      .user-data {
        background-color: #fff;
        border-radius: 1rem;
        grid-row: 1 / span 1;
        width: 50%;
        padding: 10px;
        height: fit-content;
      }
      .graphcontainer {
        grid-row: 2 / span 1;
        background-color: #fff;
        border-radius: 1rem;
        margin-top: 10px;
        margin-bottom: -50px;
        height: auto;
      }
      .graph {
        width: auto;
        height: 150%;
        margin-bottom: -10px;
      }

      .ev {
        text-align: center;
      }
    </style>
  </head>
  <body>
    {% include 'navbarlogged.html' %}
    <div class="container" style="height: fit-content">
      <div class="main mt-4">
        <div class="user-data pb-4 mb-5">
          <h1 class="mb-3">
            Datos de {{ user.first_name }} {{ user.last_name }}
          </h1>
          <div class="row">
            <div class="col-md-6">
              <b>Nombre: </b>{{ user.first_name }} {{ user.last_name }}
            </div>
            <div class="col-md-6">
              <b>Nombre de usuario: </b> {{ user.username }}
            </div>
            <div class="col-md-6"><b>Edad: </b>{{ age }}</div>
            <div class="col-md-6">
              <b>Genero: </b>{% if user.gender=="M" %} Hombre {% else %} Mujer
              {% endif %}
            </div>
            <div class="col-md-6">
              <b>Medicina: </b> {%if actual_medicine %} {{ medicine_name }} {{
              actual_medicine.dose }} {% else %} No tiene una medicina asignada.
              {% endif %}
            </div>
            <div class="col-md-6">
              <b>Doctor: </b> {{ doctor.first_name }} {{ doctor.last_name }}
            </div>
            <div class="col-md-6">
              <b>Mano dominante</b>: {% if user.handedness == "right" %} Diestro
              {% else %} Zurdo {% endif %}
            </div>
          </div>
        </div>

        <div class="graphcontainer mt-5">
          <h1 class="ev my-2">Evoluci√≥n</h1>
          <div id="graph" class="graph"></div>
        </div>
      </div>
    </div>

    <script type="module">
      const margin = { top: 10, right: 40, bottom: 40, left: 40 };
      const width =
        document.getElementById("graph").clientWidth -
        margin.left -
        margin.right;
      const height = document.getElementById("graph").clientHeight;

      // Set up the x and y scales

      const x = d3.scaleTime().range([0, width]);

      const y = d3.scaleLinear().range([height, 0]);

      // Create the SVG element and append it to the chart container

      const svg = d3
        .select("#graph")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

      // Create a fake dataset

      const dataset = [
        { date: new Date("2022-01-01"), value: 1 },
        { date: new Date("2022-02-01"), value: 1 },
        { date: new Date("2022-03-01"), value: 2 },
        { date: new Date("2022-04-08"), value: 2 },
        { date: new Date("2022-05-01"), value: 3 },
        { date: new Date("2022-06-01"), value: 4 },
        { date: new Date("2022-07-01"), value: 4 },
        { date: new Date("2022-08-01"), value: 4 },
        { date: new Date("2022-09-01"), value: 6 },
        { date: new Date("2022-10-01"), value: 5 },
        { date: new Date("2022-11-01"), value: 6 },
        { date: new Date("2022-12-01"), value: 6 },
        { date: new Date("2023-01-01"), value: 6 },
        { date: new Date("2023-02-01"), value: 6 },
        { date: new Date("2023-03-01"), value: 6 },
        { date: new Date("2023-04-01"), value: 6 },
        { date: new Date("2023-05-01"), value: 6 },
        { date: new Date("2023-06-01"), value: 6 },
        { date: new Date("2023-07-01"), value: 6 },
        { date: new Date("2023-08-01"), value: 6 },
        { date: new Date("2023-09-01"), value: 6 },
        { date: new Date("2023-10-01"), value: 6 },
        { date: new Date("2023-11-01"), value: 6 },
        { date: new Date("2023-12-01"), value: 6 },
        { date: new Date("2024-01-01"), value: 6 },
      ];
      const dataset2 = [
        { date: new Date("2022-01-01"), value: 2 },
        { date: new Date("2022-02-01"), value: 2 },
        { date: new Date("2022-03-01"), value: 3 },
        { date: new Date("2022-04-08"), value: 3 },
        { date: new Date("2022-05-01"), value: 4 },
        { date: new Date("2022-06-01"), value: 5 },
        { date: new Date("2022-07-01"), value: 6 },
        { date: new Date("2022-08-01"), value: 6 },
        { date: new Date("2022-09-01"), value: 5 },
        { date: new Date("2022-10-01"), value: 4 },
        { date: new Date("2022-11-01"), value: 3 },
        { date: new Date("2022-12-01"), value: 3 },
        { date: new Date("2022-12-01"), value: 3 },
      ];
      // Order the dataset by date
      dataset.sort((a, b) => a.date - b.date);

      // Define the x and y domains

      x.domain(d3.extent(dataset, (d) => d.date));
      y.domain([0, d3.max(dataset, (d) => d.value)]);

      // Add the x-axis

      svg
        .append("g")
        .attr("transform", `translate(0,${height})`)
        .call(
          d3
            .axisBottom(x)
            .ticks(d3.timeMonth.every(1))
            .tickFormat(d3.timeFormat("%m %Y"))
        )
        .selectAll("text")
        .style("font-size", "10px"); // Set the font size

      // Add the y-axis

      svg
        .append("g")
        .call(d3.axisLeft(y))
        .selectAll("text")
        .style("font-size", "14px"); // Set the font size

      // Create the line generator

      const line = d3
        .line()
        .x((d) => x(d.date))
        .y((d) => y(d.value));

      // Add the line path to the SVG element

      svg
        .append("path")
        .datum(dataset)
        .attr("fill", "none")
        .attr("stroke", "steelblue")
        .attr("stroke-width", 1)
        .attr("d", line);
      svg
        .append("path")
        .datum(dataset2)
        .attr("fill", "none")
        .attr("stroke", "red")
        .attr("stroke-width", 1)
        .attr("d", line);
      const legendData = [
        { name: "Dataset 1", color: "steelblue" },
        { name: "Dataset 2", color: "red" },
      ];

      // Create legend container
      const legendGroup = svg
        .append("g")
        .attr("id", "legend")
        .attr("transform", `translate(${width - margin.right}, 10)`);

      // Create legend items
      const legendItems = legendGroup
        .selectAll(".legend-item")
        .data(legendData)
        .enter()
        .append("g")
        .attr("class", "legend-item")
        .attr("transform", (d, i) => `translate(0, ${i * 20})`);

      // Add colored squares
      legendItems
        .append("rect")
        .attr("width", 10)
        .attr("height", 10)
        .attr("fill", (d) => d.color);

      // Add legend text
      legendItems
        .append("text")
        .attr("x", 15)
        .attr("y", 10)
        .text((d) => d.name)
        .attr("font-size", "12px"); // Set the font size
    </script>
  </body>
</html>
